pipeline {
  agent any

  environment {
    VIRTUAL_ENV = 'venv'
  }

  stages {
    stage('Setup') {
      steps {
        script {
          if (!fileExists("${env.WORKSPACE}/${VIRTUAL_ENV}")) {
            powershell '''
$userPython = 'C:\\Users\\kamel\\AppData\\Local\\Programs\\Python\\Python311\\python.exe'
if (Test-Path $userPython) {
  & $userPython -m venv venv
} elseif (Get-Command py -ErrorAction SilentlyContinue) {
  py -3 -m venv venv
} elseif (Get-Command python -ErrorAction SilentlyContinue) {
  python -m venv venv
} else {
  Write-Error "Python is not installed or not on PATH for the Jenkins service user. Install Python 3 or add it to PATH."
}
'''
          }
          powershell '''& "venv\\Scripts\\python.exe" -m pip install --upgrade pip'''
          powershell '''& "venv\\Scripts\\python.exe" -m pip install -r requirements.txt'''
        }
      }
    }

    stage('Lint') {
      steps {
        powershell '''& "venv\\Scripts\\python.exe" -m flake8 app.py'''
      }
    }

    stage('Test') {
      steps {
        powershell '''& "venv\\Scripts\\python.exe" -m pytest --maxfail=1 --disable-warnings'''
      }
    }

    stage('Coverage') {
      steps {
        powershell '''& "venv\\Scripts\\python.exe" -m coverage run -m pytest'''
        powershell '''& "venv\\Scripts\\python.exe" -m coverage report'''
        // optional HTML:
        // sh "source ${VIRTUAL_ENV}/bin/activate && coverage html"
        // archiveArtifacts artifacts: 'htmlcov/**', onlyIfSuccessful: true, allowEmptyArchive: true
      }
    }

    stage('Security Scan') {
      steps {
        powershell '''
$env:PYTHONIOENCODING = 'utf-8'
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
$OutputEncoding = [Console]::OutputEncoding
& "venv\\Scripts\\python.exe" -m bandit -r . -f json -o bandit-report.json
'''
        powershell '''
# Show report in console using UTF-8
Get-Content -Raw -Encoding UTF8 bandit-report.json | Write-Output
'''
      }
    }

    stage('Deploy') {
      steps {
        echo "Deploying application..."
        // Placeholder: simulate deploy
        powershell "Write-Host 'Deployment successful!'"
      }
    }
  }

  post {
    always {
      cleanWs()
    }
  }
}
